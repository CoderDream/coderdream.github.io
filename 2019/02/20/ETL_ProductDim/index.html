

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="CoderDream">
  <meta name="keywords" content="">
  
    <meta name="description" content="生成产品维度数据 刷新 Project_Detail 表的上一个版本的项目ID">
<meta property="og:type" content="article">
<meta property="og:title" content="ETL最佳实践之生成产品维度">
<meta property="og:url" content="http://coderdream.github.io/2019/02/20/ETL_ProductDim/index.html">
<meta property="og:site_name" content="梦幻代码工作室">
<meta property="og:description" content="生成产品维度数据 刷新 Project_Detail 表的上一个版本的项目ID">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://coderdream.github.io/ETL_ProductDim%5C0200.png">
<meta property="og:image" content="http://coderdream.github.io/ETL_ProductDim%5C0201.png">
<meta property="og:image" content="http://coderdream.github.io/ETL_ProductDim%5C0202.png">
<meta property="og:image" content="http://coderdream.github.io/ETL_ProductDim%5C0203.png">
<meta property="og:image" content="http://coderdream.github.io/ETL_ProductDim%5C0204.png">
<meta property="og:image" content="http://coderdream.github.io/ETL_ProductDim%5C0205.png">
<meta property="og:image" content="http://coderdream.github.io/ETL_ProductDim%5C0206.png">
<meta property="og:image" content="http://coderdream.github.io/ETL_ProductDim%5C0207.png">
<meta property="og:image" content="http://coderdream.github.io/ETL_ProductDim%5C0208.png">
<meta property="og:image" content="http://coderdream.github.io/ETL_ProductDim%5C0209.png">
<meta property="og:image" content="http://coderdream.github.io/ETL_ProductDim%5C0210.png">
<meta property="og:image" content="http://coderdream.github.io/ETL_ProductDim%5C0211.png">
<meta property="og:image" content="http://coderdream.github.io/ETL_ProductDim%5C0212.png">
<meta property="og:image" content="http://coderdream.github.io/ETL_ProductDim%5C0213.png">
<meta property="og:image" content="http://coderdream.github.io/ETL_ProductDim%5C0301.png">
<meta property="og:image" content="http://coderdream.github.io/ETL_ProductDim%5C0302.png">
<meta property="og:image" content="http://coderdream.github.io/ETL_ProductDim%5C0303.png">
<meta property="og:image" content="http://coderdream.github.io/ETL_ProductDim%5C0401.png">
<meta property="article:published_time" content="2019-02-20T06:42:18.000Z">
<meta property="article:modified_time" content="2022-07-26T01:52:14.861Z">
<meta property="article:author" content="CoderDream">
<meta property="article:tag" content="ETL">
<meta property="article:tag" content="MessageBox">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://coderdream.github.io/ETL_ProductDim%5C0200.png">
  
  
  
  <title>ETL最佳实践之生成产品维度 - 梦幻代码工作室</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"coderdream.github.io","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>CoderDream</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="ETL最佳实践之生成产品维度"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2019-02-20 14:42" pubdate>
          2019年2月20日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          2.9k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          24 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">ETL最佳实践之生成产品维度</h1>
            
            
              <div class="markdown-body">
                
                <ul>
<li>生成产品维度数据</li>
<li>刷新 Project_Detail 表的上一个版本的项目ID<br><escape><span id="more"></span></escape></li>
</ul>
<p>&nbsp;</p>
<h1 id="查找项目列表（在101上）"><a href="#查找项目列表（在101上）" class="headerlink" title="查找项目列表（在101上）"></a>查找项目列表（在101上）</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span><br>	<span class="hljs-operator">*</span> <br><span class="hljs-keyword">FROM</span><br>	ISBG_Project <br><span class="hljs-keyword">WHERE</span><br>	( OBDORPPC <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;PPC&#x27;</span> <span class="hljs-keyword">AND</span> CustomerNo <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;00106%&#x27;</span> <span class="hljs-keyword">AND</span> ProjectStartDateTime <span class="hljs-operator">&gt;=</span> <span class="hljs-string">&#x27;2018-1-1&#x27;</span> ) <br>	<span class="hljs-keyword">OR</span> ( ProjectNewNo <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;IDLE20180308127&#x27;</span> ) <br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><br>	CreateDate <span class="hljs-keyword">DESC</span><br></code></pre></td></tr></table></figure>



<h1 id="生成产品维度数据"><a href="#生成产品维度数据" class="headerlink" title="生成产品维度数据"></a>生成产品维度数据</h1><h2 id="1-思路"><a href="#1-思路" class="headerlink" title="1. 思路"></a>1. 思路</h2><ol>
<li>数据库：业务库、BI库  </li>
<li>涉及的表：业务库（ISBG_Project）、BI库（PRODUCT_AEGIS  、Project_Detail）</li>
<li>将 <strong>ISBG_Project表</strong> 中的 <strong>BeProduct</strong>、<strong>BeProductName</strong>  两个字段查询出来得到结果集，然后刷新维度表的数据，有就略过，没有就新增  </li>
<li>刷新 <strong>Project_Detail</strong> 的 产品信息</li>
</ol>
<ul>
<li>查询脚本<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span><br>	a.BeProduct,<br>	a.BeProductName<br><span class="hljs-keyword">FROM</span><br>	ISBG_Project a<br><span class="hljs-keyword">WHERE</span><br>	a.BeProduct <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span><br><span class="hljs-keyword">AND</span> a.BeProductName <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span><br><span class="hljs-keyword">AND</span> a.BeProduct <span class="hljs-operator">!=</span> <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">AND</span> a.BeProductName <span class="hljs-operator">!=</span> <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span><br>	a.BeProduct,<br>	a.BeProductName<br></code></pre></td></tr></table></figure></li>
<li>查询结果<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">BeProduct	</span><span class="hljs-keyword">BeProductName</span><br><span class="hljs-keyword"></span> IPD	Hisales<br>...<br>中间件云-开发	中间件云<br>终端设计&amp;验证&amp;软件开发过程管理	CMC<br></code></pre></td></tr></table></figure></li>
</ul>
<h1 id="刷新-Project-Detail-表的上一个版本的项目ID"><a href="#刷新-Project-Detail-表的上一个版本的项目ID" class="headerlink" title="刷新 Project_Detail 表的上一个版本的项目ID"></a>刷新 Project_Detail 表的上一个版本的项目ID</h1><h2 id="1-思路-1"><a href="#1-思路-1" class="headerlink" title="1. 思路"></a>1. 思路</h2><ol>
<li>数据库：业务库、BI库  </li>
<li>涉及的表：业务库（ISBG_Project）、BI库（Project_Detail）</li>
<li>通过脚本查询得到所有版本信息，按项目开始时间排序并增加行号，当前项目的行号减一即为前一个项目，  </li>
<li>将得到的 <strong>ProjectID</strong> 刷新到 <strong>Project_Detail表</strong> 的 <strong>PreviousVersionProjectID</strong></li>
</ol>
<ul>
<li><p>查询脚本</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span><br>	<span class="hljs-built_in">ROW_NUMBER</span> () <span class="hljs-keyword">OVER</span> (<br>		<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><br>			a.ProjectStartDateTime<br>	) <span class="hljs-keyword">AS</span> row_number,<br>	a.id,<br>	a.ProjectStartDateTime,<br>	a.BeProduct,<br>	a.BeProductName<br><span class="hljs-keyword">FROM</span><br>	ISBG_Project a<br><span class="hljs-keyword">JOIN</span> (<br>	<span class="hljs-keyword">SELECT</span><br>		ip.BeProduct,<br>		ip.BeProductName<br>	<span class="hljs-keyword">FROM</span><br>		ISBG_Project ip<br>	<span class="hljs-keyword">WHERE</span><br>		id <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;3a88df6c-83be-4903-a923-f2c80abcf3be&#x27;</span><br>) b <span class="hljs-keyword">ON</span> a.BeProduct <span class="hljs-operator">=</span> b.BeProduct<br><span class="hljs-keyword">AND</span> a.BeProductName <span class="hljs-operator">=</span> b.BeProductName<br></code></pre></td></tr></table></figure>
</li>
<li><p>查询结果</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">RowNumber</span>	id							ProjectStartDateTime	BeProduct	BeProductName<br><span class="hljs-attribute">1</span>	<span class="hljs-number">290</span>a08b8-<span class="hljs-number">241</span>a-<span class="hljs-number">486</span>b-<span class="hljs-number">90</span>a0-<span class="hljs-number">7</span>d57e9ce32ab		<span class="hljs-number">2018</span>-<span class="hljs-number">10</span>-<span class="hljs-number">24</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>.<span class="hljs-number">000</span>	Innovation	PQM<br><span class="hljs-attribute">2</span>	<span class="hljs-number">3</span>a88df6c-<span class="hljs-number">83</span>be-<span class="hljs-number">4903</span>-a923-f2c80abcf3be		<span class="hljs-number">2018</span>-<span class="hljs-number">11</span>-<span class="hljs-number">19</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>.<span class="hljs-number">000</span>	innovation	PQM<br><span class="hljs-attribute">3</span>	d375e63a-a952-<span class="hljs-number">48</span>c0-<span class="hljs-number">84</span>a6-<span class="hljs-number">3666</span>ef9630fc		<span class="hljs-number">2018</span>-<span class="hljs-number">12</span>-<span class="hljs-number">17</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>.<span class="hljs-number">000</span>	innovation	PQM<br></code></pre></td></tr></table></figure>

</li>
<li><p>整体步骤：<br><img src="/ETL_ProductDim%5C0200.png" srcset="/img/loading.gif" lazyload>  </p>
</li>
<li><p>第1步：<br><img src="/ETL_ProductDim%5C0201.png" srcset="/img/loading.gif" lazyload>  </p>
</li>
<li><p>第2步：过滤已经处理过的数据<br><img src="/ETL_ProductDim%5C0202.png" srcset="/img/loading.gif" lazyload> </p>
</li>
<li><p>第3步：获取版本编号<br><img src="/ETL_ProductDim%5C0203.png" srcset="/img/loading.gif" lazyload>   </p>
</li>
<li><p>查询脚本（通过产品信息获得版本编号）  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <br>a.a_number,<br><span class="hljs-built_in">ROW_NUMBER</span> () <span class="hljs-keyword">OVER</span> (<br>		<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><br>			a.BeProduct,a.BeProductName,b.ProjectStartDateTime<br>	) <span class="hljs-keyword">AS</span> row_number,<br>b.ID,b.ProjectStartDateTime,a.BeProduct,a.BeProductName <span class="hljs-keyword">from</span><br>(<br><span class="hljs-keyword">select</span> <span class="hljs-built_in">ROW_NUMBER</span> () <span class="hljs-keyword">OVER</span> (<br>	<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><br>			BeProduct,BeProductName<br>	) <span class="hljs-keyword">AS</span> a_number,<br>BeProduct,BeProductName <span class="hljs-keyword">from</span> ISBG_Project <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> BeProduct,BeProductName<br>) a<br><span class="hljs-keyword">join</span> ISBG_Project b <span class="hljs-keyword">on</span> b.BeProduct<span class="hljs-operator">=</span>a.BeProduct <span class="hljs-keyword">and</span> b.BeProductName<span class="hljs-operator">=</span>a.BeProductName<br></code></pre></td></tr></table></figure></li>
<li><p>第4步：按项目ID排序左侧数据<br><img src="/ETL_ProductDim%5C0204.png" srcset="/img/loading.gif" lazyload>  </p>
</li>
<li><p>第5步：按项目ID排序右侧收据<br><img src="/ETL_ProductDim%5C0205.png" srcset="/img/loading.gif" lazyload>  </p>
</li>
<li><p>第6步：多播右侧版本编号数据，以便二次使用<br><img src="/ETL_ProductDim%5C0206.png" srcset="/img/loading.gif" lazyload>  </p>
</li>
<li><p>第7步：合并连接数据获取当前版本编号<br><img src="/ETL_ProductDim%5C0207.png" srcset="/img/loading.gif" lazyload>  </p>
</li>
<li><p>第8步：计算上一版本编号<br><img src="/ETL_ProductDim%5C0208.png" srcset="/img/loading.gif" lazyload>  </p>
</li>
<li><p>第9步：按序号排序左侧数据<br><img src="/ETL_ProductDim%5C0209.png" srcset="/img/loading.gif" lazyload>  </p>
</li>
<li><p>第10步：按序号排序右侧侧数据<br><img src="/ETL_ProductDim%5C0210.png" srcset="/img/loading.gif" lazyload>  </p>
</li>
<li><p>第11步：合并连接数据获取上一版本编号<br><img src="/ETL_ProductDim%5C0211.png" srcset="/img/loading.gif" lazyload>  </p>
</li>
<li><p>第12步：更新记录<br><img src="/ETL_ProductDim%5C0212.png" srcset="/img/loading.gif" lazyload><br><img src="/ETL_ProductDim%5C0213.png" srcset="/img/loading.gif" lazyload></p>
</li>
</ul>
<h1 id="准备新需求的测试数据"><a href="#准备新需求的测试数据" class="headerlink" title="准备新需求的测试数据"></a>准备新需求的测试数据</h1><h2 id="写入三张表"><a href="#写入三张表" class="headerlink" title="写入三张表"></a>写入三张表</h2><ol>
<li>HR_IMPORT_Member(读写，员工基本数据，BSM和技术方向)，</li>
<li>HR_IMPORT_WorkStatus(读写,考勤、请假、调休数据表)；</li>
<li>HR_IMPORT_LOG(读写，操作日志)</li>
</ol>
<h2 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h2><ol>
<li>交付人员基础数据表：人资程序将BSM数据同步到这个表，如果工号以存在就覆盖数据，否则新增数据。<br> <img src="/ETL_ProductDim%5C0301.png" srcset="/img/loading.gif" lazyload> </li>
<li>交付人员在岗、请假、调休数据表：每月考勤、请假、调休数据锁定后，凌晨5点，人资程序将数据新增到这个表。所有字段都不允许为空，且是0~255之间（byte类型）。产能系统每月自动清空5个月前的数据。<br> <img src="/ETL_ProductDim%5C0302.png" srcset="/img/loading.gif" lazyload> </li>
<li>处理日志表：每次从人资系统导入数据到产能数据库后都需要在此表中插入日志。<br>如果导入的是基本数据，ImportType写入1，DataStartDate和DataEndDate填写导入数据当日的日期，日期不要带有时间信息。<br>如果导入的是在岗状态数据，ImportType写入2，DataStartDate写入本批次数据最早的日期，DataEndDate写入本批次数据最后的日期。<br><img src="/ETL_ProductDim%5C0303.png" srcset="/img/loading.gif" lazyload></li>
</ol>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ol>
<li>先从项目表中取4个未结项和4个已结项的项目，其中两个项目属于同一个产品的不同版本；</li>
<li>通过项目ID查找人力地图表，得到交付人员的员工号；</li>
<li>根据员工号，生成BSM和技术方向的模拟数据，写入<strong>交付人员基础数据表</strong>，同时写入<strong>处理日志表</strong></li>
<li>通过BI库的日期维度表得到工作日记录（暂时模拟某段时间的数据，如2019年1月~2月）</li>
<li>模拟考勤数据，工作日合计8小时，</li>
<li>将模拟数据写入<strong>考勤、请假、调休数据表</strong>，同时写入<strong>处理日志表</strong></li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> ID <span class="hljs-keyword">from</span> (<br><span class="hljs-comment">-- 两个未结项的 ISBG 项目</span><br><span class="hljs-keyword">select</span> TOP <span class="hljs-number">2</span>  ID,ProjectName,ProjectMgr_Name,ProjectStartDateTime,DepartmentName, BeProduct,BeProductName,CooperationType,IsFinish<br>  <span class="hljs-keyword">from</span> ISBG_Project <br>  <span class="hljs-keyword">where</span> <br>  OBDORPPC<span class="hljs-operator">=</span><span class="hljs-string">&#x27;PPC&#x27;</span> <span class="hljs-keyword">AND</span> OBDORPPC<span class="hljs-operator">!=</span><span class="hljs-string">&#x27;IDLE&#x27;</span> <span class="hljs-keyword">and</span> CustomerNo <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;00106%&#x27;</span> <br>	<span class="hljs-keyword">and</span> ProjectStartDateTime<span class="hljs-operator">&gt;=</span><span class="hljs-string">&#x27;2019-3-1&#x27;</span><br>	<span class="hljs-keyword">AND</span> BeProduct <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span><br>	<span class="hljs-keyword">AND</span> BeProductName <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span><br>	<span class="hljs-keyword">AND</span> BeProduct <span class="hljs-operator">!=</span> <span class="hljs-string">&#x27;&#x27;</span><br>	<span class="hljs-keyword">AND</span> BeProductName <span class="hljs-operator">!=</span> <span class="hljs-string">&#x27;&#x27;</span><br>	<span class="hljs-keyword">and</span> CooperationType <span class="hljs-operator">=</span><span class="hljs-string">&#x27;FP&#x27;</span><br><span class="hljs-comment">-- 两个已结项的 ISBG 项目</span><br><span class="hljs-keyword">union</span><br>  <span class="hljs-keyword">select</span> TOP <span class="hljs-number">2</span>  a.ID,a.ProjectName,a.ProjectMgr_Name,a.ProjectStartDateTime,a.BeProduct,a.DepartmentName,a.BeProductName,a.CooperationType,a.IsFinish<br>  <span class="hljs-keyword">from</span> ISBG_Project a<br>  <span class="hljs-keyword">join</span> <br>  ISBG_Project_Finish b<br>  <span class="hljs-keyword">on</span> a.ID <span class="hljs-operator">=</span> b.ProjectId<br>  <span class="hljs-keyword">where</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">1</span><br>  <span class="hljs-keyword">AND</span> OBDORPPC<span class="hljs-operator">=</span><span class="hljs-string">&#x27;PPC&#x27;</span> <br> <span class="hljs-comment">-- AND OBDORPPC!=&#x27;IDLE&#x27; </span><br>  <span class="hljs-comment">--AND OBDORPPC!=&#x27;New&#x27; </span><br>  <span class="hljs-comment">-- AND OBDORPPC!=&#x27;OPD&#x27; </span><br>  <span class="hljs-comment">-- and CustomerNo not like &#x27;00106%&#x27; </span><br>  <span class="hljs-comment">-- and ProjectStartDateTime&gt;=&#x27;2018-12-1&#x27;</span><br>  <span class="hljs-keyword">and</span> ProjectNewNo<span class="hljs-operator">!=</span><span class="hljs-string">&#x27;IDLE20180308127&#x27;</span> <br>	<span class="hljs-keyword">AND</span> BeProduct <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span><br>	<span class="hljs-keyword">AND</span> BeProductName <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span><br>	<span class="hljs-keyword">AND</span> BeProduct <span class="hljs-operator">!=</span> <span class="hljs-string">&#x27;&#x27;</span><br>	<span class="hljs-keyword">AND</span> BeProductName <span class="hljs-operator">!=</span> <span class="hljs-string">&#x27;&#x27;</span><br>	<span class="hljs-keyword">and</span> CooperationType <span class="hljs-operator">=</span><span class="hljs-string">&#x27;FP&#x27;</span><br><span class="hljs-keyword">union</span><br><span class="hljs-comment">-- 相同的两个项目，一个已结项，一个未结项</span><br><span class="hljs-keyword">select</span> TOP <span class="hljs-number">2</span>  ID,ProjectName,ProjectMgr_Name,ProjectStartDateTime,DepartmentName,BeProduct,BeProductName,CooperationType,IsFinish<br>  <span class="hljs-keyword">from</span> ISBG_Project <br>  <span class="hljs-keyword">where</span><br>  <span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">1</span>  <br>  <span class="hljs-comment">-- AND ProjectStartDateTime&gt;=&#x27;2018-8-1&#x27;  </span><br>  <span class="hljs-comment">--order by CreateDate desc</span><br>  <span class="hljs-keyword">AND</span> BeProduct<span class="hljs-operator">=</span><span class="hljs-string">&#x27;HIC云&#x27;</span>	<br>  <span class="hljs-keyword">AND</span> BeProductName<span class="hljs-operator">=</span><span class="hljs-string">&#x27;eSee&#x27;</span><br>	<span class="hljs-keyword">and</span> CooperationType <span class="hljs-operator">=</span><span class="hljs-string">&#x27;FP&#x27;</span><br><span class="hljs-keyword">union</span><br><span class="hljs-comment">-- IDLE 项目</span><br>	<span class="hljs-keyword">select</span> TOP <span class="hljs-number">1</span> ID,ProjectName,ProjectMgr_Name,ProjectStartDateTime,DepartmentName,BeProduct,BeProductName,CooperationType,IsFinish<br>	<span class="hljs-keyword">from</span> ISBG_Project <br>	<span class="hljs-keyword">where</span> ProjectNewNo<span class="hljs-operator">=</span><span class="hljs-string">&#x27;IDLE20180308127&#x27;</span><br><span class="hljs-keyword">union</span><br><span class="hljs-comment">-- SSBG 项目</span><br>	<span class="hljs-keyword">select</span> TOP <span class="hljs-number">1</span> ID,ProjectName,ProjectMgr_Name,ProjectStartDateTime,DepartmentName,BeProduct,BeProductName,CooperationType,IsFinish<br>	<span class="hljs-keyword">from</span> ISBG_Project <br>	<span class="hljs-keyword">where</span> DepartmentName <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;SSBG-BU17%&#x27;</span> <br>	<span class="hljs-keyword">and</span> ProjectStartDateTime<span class="hljs-operator">&gt;=</span><span class="hljs-string">&#x27;2018-12-1&#x27;</span> <br>	<span class="hljs-comment">--AND BeProduct IS NOT NULL</span><br>	<span class="hljs-comment">--AND BeProductName IS NOT NULL</span><br>	<span class="hljs-comment">--AND BeProduct != &#x27;&#x27;</span><br>	<span class="hljs-comment">--AND BeProductName != &#x27;&#x27;</span><br>) a <br><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> a.ProjectStartDateTime <span class="hljs-keyword">desc</span>;<br></code></pre></td></tr></table></figure>

<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs oxygene"><span class="hljs-keyword">SELECT</span> COUNT<span class="hljs-comment">(*) FROM HR_IMPORT_WorkStatus a WHERE a.WorkingHours &lt;&gt; 8;</span><br><span class="hljs-comment">SELECT COUNT(*)</span> <span class="hljs-keyword">FROM</span> HR_IMPORT_WorkStatus a <span class="hljs-keyword">WHERE</span> a.CompassionateLeaveHours &gt; <span class="hljs-number">0</span><span class="hljs-punctuation">;</span><br><span class="hljs-keyword">SELECT</span> COUNT<span class="hljs-comment">(*) FROM HR_IMPORT_WorkStatus a WHERE a.SickLeaveHours &gt; 0;</span><br><span class="hljs-comment">SELECT COUNT(*)</span> <span class="hljs-keyword">FROM</span> HR_IMPORT_WorkStatus a <span class="hljs-keyword">WHERE</span> a.OtherPayLeavelHours &gt; <span class="hljs-number">0</span><span class="hljs-punctuation">;</span><br><br><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span>(a.WorkingHours), COUNT<span class="hljs-comment">(*) FROM HR_IMPORT_WorkStatus a WHERE a.WorkingHours &lt;&gt; 8 GROUP BY a.WorkingHours ORDER BY a.WorkingHours;</span><br><span class="hljs-comment">SELECT DISTINCT(a.CompassionateLeaveHours), COUNT(*)</span> <span class="hljs-keyword">FROM</span> HR_IMPORT_WorkStatus a <span class="hljs-keyword">WHERE</span> a.CompassionateLeaveHours &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> a.CompassionateLeaveHours<span class="hljs-punctuation">;</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span>(a.SickLeaveHours), COUNT<span class="hljs-comment">(*) FROM HR_IMPORT_WorkStatus a WHERE a.SickLeaveHours &gt; 0 GROUP BY a.SickLeaveHours;</span><br><span class="hljs-comment">SELECT DISTINCT(a.OtherPayLeavelHours), COUNT(*)</span> <span class="hljs-keyword">FROM</span> HR_IMPORT_WorkStatus a <span class="hljs-keyword">WHERE</span> a.OtherPayLeavelHours &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> a.OtherPayLeavelHours<span class="hljs-punctuation">;</span><br></code></pre></td></tr></table></figure>


<h1 id="产能偏差"><a href="#产能偏差" class="headerlink" title="产能偏差"></a>产能偏差</h1><h2 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h2><h3 id="处理考勤数据"><a href="#处理考勤数据" class="headerlink" title="处理考勤数据"></a>处理考勤数据</h3><ul>
<li>以 Project_AEGIS 为项目源头，过滤 Project_Detail 中已处理（Processed&gt;0）的数据</li>
<li>右联查询考勤数据（TODO）</li>
<li></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span><br>	a.ProjectID,<br>	a.WorkID,<br>	c.BSM,<br>	c.RecordDate,<br>	c.BSD,<br>	c.RealCapacity,<br>	c.CapacityDeviation <br><span class="hljs-keyword">FROM</span><br>	HumanMap a<br>	<span class="hljs-keyword">JOIN</span> DEV_BSD_IDLE c <span class="hljs-keyword">ON</span> c.WorkID<span class="hljs-operator">=</span> a.WorkID <br>	<span class="hljs-keyword">AND</span> (( c.RecordDate <span class="hljs-operator">&gt;=</span> a.InPro_Date <span class="hljs-keyword">AND</span> c.RecordDate <span class="hljs-operator">&lt;</span> a.OutPro_Date ) <br>	<span class="hljs-keyword">OR</span> ( c.RecordDate <span class="hljs-operator">=</span> a.InPro_Date <span class="hljs-keyword">AND</span> a.InPro_Date <span class="hljs-operator">=</span> a.OutPro_Date )) <br>	<span class="hljs-comment">-- AND c.RealCapacity IS NOT NULL AND c.CapacityDeviation IS NOT NULL</span><br><span class="hljs-keyword">WHERE</span><br>	a.ProjectID <span class="hljs-keyword">IN</span> (<br>	<span class="hljs-keyword">SELECT</span><br>		ProjectID <br>	<span class="hljs-keyword">FROM</span><br>		Project_AEGIS <br><span class="hljs-keyword">WHERE</span><br>	ProjectID <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> ( <span class="hljs-keyword">SELECT</span> ProjectID <span class="hljs-keyword">FROM</span> Project_Detail <span class="hljs-keyword">WHERE</span> Processed <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-number">0</span> ))<br></code></pre></td></tr></table></figure>


<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs n1ql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> DEV_BSD_IDLE a <span class="hljs-keyword">where</span> a.CapacityDeviation <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">and</span> a.CapacityDeviation &lt;&gt; <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>

<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs n1ql"><span class="hljs-keyword">SELECT</span><br>	ProjectID <br><span class="hljs-keyword">FROM</span><br>	Project_AEGIS <br><span class="hljs-keyword">WHERE</span><br>	ProjectID <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> ( <span class="hljs-keyword">SELECT</span> ProjectID <span class="hljs-keyword">FROM</span> Project_Detail <span class="hljs-keyword">WHERE</span> Processed &lt;&gt; <span class="hljs-number">0</span> )<br></code></pre></td></tr></table></figure>

<p>- </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs stylus">SELECT<br>	<span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.ProjectID</span>,<br>	<span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.WorkID</span>,<br>	<span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.BSM</span> AS BSMIncome,<br>	<span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.Quality</span>,<br>	<span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.OffsetCapacity</span>,<br>	c<span class="hljs-selector-class">.BSM</span> AS BSMBase,<br>	c<span class="hljs-selector-class">.RecordDate</span>,<br>	c<span class="hljs-selector-class">.BSD</span> <br>FROM<br>	HumanMapBak <span class="hljs-selector-tag">a</span><br>	LEFT OUTER JOIN PDRC_BSM_Dispatch <span class="hljs-selector-tag">b</span> ON <span class="hljs-selector-tag">b</span>.ProjectID= <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.ProjectID</span> <br>	AND <span class="hljs-selector-tag">b</span>.WorkID= <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.WorkID</span><br>	JOIN DEV_BSD_IDLE c ON c.WorkID= <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.WorkID</span> <br>	AND ((<br>			c.RecordDate&gt;= <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.InPro_Date</span> <br>			AND c.RecordDate&lt; <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.OutPro_Date</span> <br>			) <br>	OR ( c.RecordDate= <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.InPro_Date</span> AND <span class="hljs-selector-tag">a</span>.InPro_Date= <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.OutPro_Date</span> )) <br>	-- LEFT JOIN <br>WHERE<br>	<span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.ProjectID</span> <span class="hljs-keyword">in</span> (<span class="hljs-string">&#x27;2e8c8397-4be8-4f34-9527-ce239d4f2068&#x27;</span>,<br><span class="hljs-string">&#x27;3a88df6c-83be-4903-a923-f2c80abcf3be&#x27;</span>,<br><span class="hljs-string">&#x27;a6318b58-8b07-455a-81ac-6f0adec657bf&#x27;</span>,<br><span class="hljs-string">&#x27;a989e256-971a-49e1-a5e0-620d488f5c3a&#x27;</span>)<br></code></pre></td></tr></table></figure>

<p>- </p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs routeros">UPDATE [BJC_PDRCBI].[dbo].[DEV_BSD_IDLE]<br>   <span class="hljs-built_in">SET</span> [RealCapacity] = <span class="hljs-literal">NULL</span><br>      ,[CapacityDeviation] = <span class="hljs-literal">NULL</span><br> WHERE <span class="hljs-attribute">1</span>=1<br>GO<br></code></pre></td></tr></table></figure>
<ul>
<li>查询 IDLE 表<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs n1ql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> DEV_BSD_IDLE a <span class="hljs-keyword">where</span> a.WorkID=<span class="hljs-string">&#x27;B-41018&#x27;</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="日期与弹窗-MessageBox"><a href="#日期与弹窗-MessageBox" class="headerlink" title="日期与弹窗 MessageBox"></a>日期与弹窗 MessageBox</h2><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-variable">DateTime</span> <span class="hljs-variable">dt</span> <span class="hljs-operator">=</span> <span class="hljs-variable">DateTime</span><span class="hljs-operator">.</span><span class="hljs-built_in">Now</span><span class="hljs-operator">;</span><br><span class="hljs-operator">//</span><span class="hljs-variable">DateTime</span> <span class="hljs-variable">dt</span> <span class="hljs-operator">=</span> <span class="hljs-variable">new</span> <span class="hljs-variable">DateTime</span><span class="hljs-punctuation">(</span><span class="hljs-number">2019</span><span class="hljs-operator">,</span> <span class="hljs-number">4</span><span class="hljs-operator">,</span> <span class="hljs-number">15</span><span class="hljs-punctuation">)</span><span class="hljs-operator">;</span><br><span class="hljs-variable">string</span> <span class="hljs-variable">dtString</span> <span class="hljs-operator">=</span> <span class="hljs-variable">dt</span><span class="hljs-operator">.</span><span class="hljs-built_in">ToString</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-operator">;</span><br><span class="hljs-operator">//</span><span class="hljs-variable">MessageBox</span><span class="hljs-operator">.</span><span class="hljs-built_in">Show</span><span class="hljs-punctuation">(</span><span class="hljs-variable">dtString</span><span class="hljs-punctuation">)</span><span class="hljs-operator">;</span><br><span class="hljs-variable">DateTime</span> <span class="hljs-variable">lastFinancialDate</span> <span class="hljs-operator">=</span> <span class="hljs-variable">new</span> <span class="hljs-variable">DateTime</span><span class="hljs-punctuation">(</span><span class="hljs-variable">dt</span><span class="hljs-operator">.</span><span class="hljs-variable">Year</span><span class="hljs-operator">,</span> <span class="hljs-variable">dt</span><span class="hljs-operator">.</span><span class="hljs-variable">Month</span><span class="hljs-operator">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-operator">;</span><br><span class="hljs-variable">lastFinancialDate</span> <span class="hljs-operator">=</span> <span class="hljs-variable">lastFinancialDate</span><span class="hljs-operator">.</span><span class="hljs-variable">AddMonths</span><span class="hljs-punctuation">(</span><span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-operator">;</span><br><span class="hljs-variable">MessageBox</span><span class="hljs-operator">.</span><span class="hljs-built_in">Show</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;FinancialDay: &quot;</span> <span class="hljs-operator">+</span> <span class="hljs-variable">Dts</span><span class="hljs-operator">.</span><span class="hljs-built_in">Variables</span><span class="hljs-punctuation">[</span><span class="hljs-string">&quot;FinancialDay&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-operator">.</span><span class="hljs-variable">Value</span><span class="hljs-operator">.</span><span class="hljs-built_in">ToString</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-operator">;</span><br><span class="hljs-variable">Dts</span><span class="hljs-operator">.</span><span class="hljs-built_in">Variables</span><span class="hljs-punctuation">[</span><span class="hljs-string">&quot;LastFinancialDate&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-operator">.</span><span class="hljs-variable">Value</span> <span class="hljs-operator">=</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">dt</span><span class="hljs-operator">.</span><span class="hljs-variable">Day</span> <span class="hljs-operator">&gt;</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">int</span><span class="hljs-punctuation">)</span><span class="hljs-variable">Dts</span><span class="hljs-operator">.</span><span class="hljs-built_in">Variables</span><span class="hljs-punctuation">[</span><span class="hljs-string">&quot;FinancialDay&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-operator">.</span><span class="hljs-variable">Value</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">?</span> <span class="hljs-variable">lastFinancialDate</span> <span class="hljs-operator">:</span> <span class="hljs-variable">lastFinancialDate</span><span class="hljs-operator">.</span><span class="hljs-variable">AddMonths</span><span class="hljs-punctuation">(</span><span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-operator">;</span><br><span class="hljs-variable">string</span> <span class="hljs-variable">lastFinancialDateString</span> <span class="hljs-operator">=</span> <span class="hljs-variable">Dts</span><span class="hljs-operator">.</span><span class="hljs-built_in">Variables</span><span class="hljs-punctuation">[</span><span class="hljs-string">&quot;LastFinancialDate&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-operator">.</span><span class="hljs-variable">Value</span><span class="hljs-operator">.</span><span class="hljs-built_in">ToString</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-operator">;</span><br><span class="hljs-operator">//</span><span class="hljs-variable">MessageBox</span><span class="hljs-operator">.</span><span class="hljs-built_in">Show</span><span class="hljs-punctuation">(</span><span class="hljs-variable">lastFinancialDateString</span><span class="hljs-punctuation">)</span><span class="hljs-operator">;</span><br></code></pre></td></tr></table></figure>

<h2 id="奖金计算"><a href="#奖金计算" class="headerlink" title="奖金计算"></a>奖金计算</h2><ol>
<li><p>查询结果得到结果集：</p>
</li>
<li><p>通过派生列整理数据，得到实际的产能（BSM*质量）<br><img src="/ETL_ProductDim%5C0401.png" srcset="/img/loading.gif" lazyload>  </p>
</li>
<li></li>
</ol>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ol>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/ljhdo/p/5174681.html">SSIS 数据类型和类型转换</a></li>
</ol>
<p>SSIS 数据类型和类型转换<br>在进行ETL开发时，数据类型（Data Type）是最基础的，但也容易被忽略，楼主使用的SQL Server 版本是2012，用此博文记录，常用的SSIS数据类型和TSQL数据类型的映射。SSIS的数据类型，是指数据流组件使用的数据类型和变量的数据类型（Data Flow 和 Variable）。</p>
<p>当数据进入Package的data flow task中时，SSIS 通过数据源组件从数据源抽取（extract）数据，获取元数据类型，并转换成SSIS支持的数据类型，SSIS的数据类型主要分为三类：字符（string），数值（numeric）和日期&#x2F;时间（date&#x2F;time），如果源数据类似不能转换成相应的SSIS 数据类型，SSIS Engine就会报错。SSIS的数据类型，以“DT_”开头，是Data Type的简写。</p>
<p>一，SSIS 数据流的数据类型和TSQL数据类型的映射</p>
<ol>
<li>字符类型</li>
</ol>
<p>字符类型用于存储字符串，在SQL Server中，使用单引号表示一个字符，但是在SSIS中，使用双引号表示一个字符串。</p>
<p>SSIS的字符类型和TSQL的数据类型的对应关系：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">DT_STR：对应TSQL的 <span class="hljs-type">varchar</span>, <span class="hljs-type">char</span>  <br>DT_WSTR：对应TSQL的 <span class="hljs-type">nchar</span>, nvarchar, <span class="hljs-type">xml</span><br></code></pre></td></tr></table></figure>
<ol start="2">
<li>数值类型</li>
</ol>
<p>数值类型分为整数和小数，SSIS的整数类型和TSQL数据类型的对应关系：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">DT_BOOL</span>：bit  <br><span class="hljs-attribute">DT_UI1</span>：tinyint，占用一个字节，非负整数，数值范围是：<span class="hljs-number">0</span>-<span class="hljs-number">255</span>  <br><span class="hljs-attribute">DT_I2</span>：smallint，占用<span class="hljs-number">2</span>个字节，有符号整数  <br><span class="hljs-attribute">DT_I4</span>：int，占用<span class="hljs-number">4</span>个字节，有符号整数  <br><span class="hljs-attribute">DT_I8</span>：bigint，占用<span class="hljs-number">8</span>个字节，有符号整数  <br><span class="hljs-attribute">DT_BYTES</span>：binary, varbinary, RowVersion<br></code></pre></td></tr></table></figure>
<p>TSQL的小数数值类型分为两类：精确小数（decimal）和近似小数（float），小数也叫实数（real），SSIS的小数类型和TSQL数据类型的对应关系：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs scss">DT_NUMERIC：精确小数，decimal  <br>DT_R4：近似小数，<span class="hljs-attribute">float</span>(<span class="hljs-number">24</span>)  <br>DT_R8：近似小数，<span class="hljs-attribute">float</span>(<span class="hljs-number">53</span>)  <br></code></pre></td></tr></table></figure>
<p>3，日期时间类型</p>
<p>SSIS的日期时间类型和TSQL数据类型的对应关系：</p>
<p>DT_DBDATE：date<br>DT_DBTIME2：time(p)<br>DT_DBTIMESTAMP：datetime<br>DT_DBTIMESTAMP2：datetime2<br>SSIS 内置函数：GETDATE() 和 GETUTCDATE() 返回值的数据类型是DT_DBTIMESTAMP，对应TSQL的DateTime，因此，只保留3位毫秒。在Expression Builder中，将时间类型转换成字符串类型，显示的毫秒数有效数值只有3位，末尾补6个0，共9位：</p>
<p>(DT_WSTR,30) GETDATE()，Evaluated Value是：2016-10-13 17:04:01.765000000<br>(DT_DBTIMESTAMP2,7) GETDATE()，Evaluated Value是：10&#x2F;13&#x2F;2016 5:01:54 PM<br>二，SSIS 变量(Variable)的数据类型和TSQL数据类型的映射</p>
<p>SSIS 变量的数据类型，不同于SSIS的数据类型，但都和SSIS的数据类型相兼容，在进行表达式求值时，SSIS自动将变量的数据类型隐式转换成SSIS的数据类型，然后进行求值。</p>
<p>Variables have a Variant data type and the expression evaluator converts the data type of a variable from a Variant subtype to an Integration Services data type before it evaluates the expression. </p>
<p>1，字符数据类型</p>
<p>字符变量和TSQL数据类型的映射关系：</p>
<p>String：char,nchar,varchar(n),nvarchar(n)<br>object：varchar(max),nvarchar(max)<br>2，数值类型</p>
<p>数值类型的变量和TSQL数据类型的映射关系：</p>
<p>Boolean：bit<br>Int64：bigint<br>Int32：int<br>Int16：smallint<br>Byte：tinyint<br>object：binary, varbinary(n), varbinary(max)<br>精确小数：Decimal 在SQL Server 2012以后，对应TSQL的decimal<br>近似小数：Single 对应TSQL的float(24),  Double 对应TSQL的float(53)<br>3，日期&#x2F;时间类型</p>
<p>日期&#x2F;时间类型的变量和TSQL数据类型的映射关系：</p>
<p>DateTime：对应TSQL的datetime<br>Object：对应TSQL的time，date，datetime2<br>三，强制类型转换</p>
<p>SSIS在进行表达式求值时，自动将一个数据类型隐式转换成相兼容的另外一个数据类型，如果类型不兼容，必须强制类型转换，否则，SSIS报错。对数据进行强制类型转换的格式是：(type) expression，在进行显式类型转换时，尽量使用窄的数据类型，这样能够提高数据传输的速度；但是，数据转换需要付出一定的代价，因此，必须权衡类型转换和数据传输对性能的影响。</p>
<p>An implicit conversion of a data type occurs when the expression evaluator automatically converts the data from one data type to another. If the data in a column does not require the full width allocated by the source data type, you might want to change the data type of the column. Making each data row as narrow as possible helps optimize performance when transferring data because the narrower each row is, the faster the data is moved from source to destination.</p>
<p>1，将字符串转换成TSQL的日期&#x2F;时间类型</p>
<p>在SSIS中，字符串常量使用双引号“”，[] 表示可选：</p>
<p>转换成date：(DT_DBDATE)”yyyy-mm-dd”<br>转换成time(n)：(DT_DBTIME2,n)”hh:mm:ss[.fffffff]”<br>转换成datetime：(DT_DBTIMESTAMP)”yyyy-mm-dd hh:mm:ss[.fff]”<br>转换成datetime2(n)：(DT_DBTIMESTAMP2,n)”yyyy-mm-dd hh:mm:ss[.fffffff]”<br>2，转换成字符串</p>
<p>字符串分为双字节字符和单字节字符，对于单字节字符，SSIS使用 DT_STR 表示，在强制类型转换时，必须制定code page和字符长度：</p>
<p>将整数5转换为单字节字符：(DT_STR,30,1252)5<br>将整数5转换为双字节字符：(DT_WSTR,30)5<br>将 DT_DBTIMESTAMP 类型转换成字符串：(DT_WSTR,30)GETDATE()，返回的数据格式是: 2016-10-13 14:55:31.248000000,GETDATE()返回的数据类型是DT_DBTIMESTAMP；<br>3，数值类型转换</p>
<p>将字符串转换成bit：(DT_BOOL)”True”<br>将小数转换成int：(DT_I4) 3.57<br>将整数转化成精确小数：(DT_NUMERIC,7,3)4000<br>四，数据类型转换的性能</p>
<p>将数据从一个SQL Server 加载到另一个SQL Server之前，如果需要转换数据类型，建议使用TSQL Conversion，这样，能简化Package的设计，提高转换速度。</p>
<p>五，参数的数据类型</p>
<p>在Execute SQL Task引用变量时，必须在Parameter Mapping Tab中设置参数的Data Type，请参考《Execute SQL Task 参数和变量的映射》</p>
<p>参考文档：</p>
<p>Integration Services (SSIS) Expressions</p>
<p>Cast (SSIS Expression)</p>
<p>Integration Services Data Types</p>
<p>SQL Server Integration Services, Data Type Mapping</p>
<p>Performance Comparison between Data Type Conversion Techniques in SSIS 2008</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Database/" class="category-chain-item">Database</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/ETL/" class="print-no-link">#ETL</a>
      
        <a href="/tags/MessageBox/" class="print-no-link">#MessageBox</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>ETL最佳实践之生成产品维度</div>
      <div>http://coderdream.github.io/2019/02/20/ETL_ProductDim/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>CoderDream</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2019年2月20日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2019/02/20/2019Week08/" title="2019年第8周">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">2019年第8周</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2019/02/15/2019Week07/" title="2019年第7周">
                        <span class="hidden-mobile">2019年第7周</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
